openapi: 3.1.0
info:
  title: Biometric Core Backend API
  version: 0.1.0
  description: >-
    REST API for biometric enrollment, authentication, and device management.
servers:
  - url: http://localhost:3000
    description: Local development
tags:
  - name: Health
  - name: Auth
  - name: Enrollment
  - name: Users
  - name: Devices
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  headers:
    XRequestId:
      description: Correlation ID echoed back on all responses.
      schema: { type: string }
    IdempotencyReplayed:
      description: True when a request with the same Idempotency-Key was replayed and a cached result is returned.
      schema: { type: boolean }
    Location:
      description: Absolute or path URL of the created resource.
      schema: { type: string }
  parameters:
    XRequestId:
      in: header
      name: X-Request-Id
      required: false
      schema: { type: string }
      description: Optional request correlation ID. Echoed back in responses.
    IdempotencyKey:
      in: header
      name: Idempotency-Key
      required: false
      schema: { type: string }
      description: Idempotency key for safely retrying mutating requests.
    Cursor:
      in: query
      name: cursor
      required: false
      schema: { type: string }
      description: Opaque pagination cursor.
    Limit:
      in: query
      name: limit
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 250
        default: 25
      description: Page size (default 25, max 250).
  responses:
    Problem:
      description: Error response
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
  schemas:
    Meta:
      type: object
      properties:
        nextCursor: { type: string, nullable: true }
        limit: { type: integer, minimum: 1, maximum: 250 }
    ProblemDetails:
      type: object
      required: [type, title, status, traceId]
      properties:
        type: { type: string, description: A URI reference that identifies the problem type }
        title: { type: string }
        status: { type: integer, format: int32 }
        detail: { type: string }
        instance: { type: string }
        code: { type: string, description: Machine-readable error code }
        traceId: { type: string, description: Correlation/trace identifier }

    User:
      type: object
      required: [id, email, firstName, lastName, createdAt]
      properties:
        id: { type: string }
        email: { type: string, format: email }
        firstName: { type: string }
        lastName: { type: string }
        createdAt: { type: string, format: date-time }

    Device:
      type: object
      required: [id, userId, credentialId, active, createdAt]
      properties:
        id: { type: string }
        userId: { type: string }
        credentialId: { type: string }
        active: { type: boolean }
        createdAt: { type: string, format: date-time }

    AuthChallengeInput:
      oneOf:
        - type: object
          required: [email]
          properties:
            email: { type: string, format: email }
        - type: object
          required: [userId]
          properties:
            userId: { type: string }
      description: Identify the user to authenticate.

    EnrollmentChallengeInput:
      oneOf:
        - type: object
          required: [email]
          properties:
            email: { type: string, format: email }
        - type: object
          required: [userId]
          properties:
            userId: { type: string }
      description: Identify the user to enroll a device for.

    ChallengeResponse:
      type: object
      required: [challengeId, publicKeyCredentialOptions]
      properties:
        challengeId: { type: string }
        publicKeyCredentialOptions:
          type: object
          description: WebAuthn options as per spec (opaque to clients).
          additionalProperties: true

    AuthVerifyInput:
      type: object
      required: [challengeId, credential]
      properties:
        challengeId: { type: string }
        credential:
          type: object
          description: WebAuthn assertion response from the client.
          additionalProperties: true

    AuthVerifyResponse:
      type: object
      required: [accessToken, refreshToken, expiresIn]
      properties:
        accessToken: { type: string }
        refreshToken: { type: string }
        expiresIn: { type: integer, format: int32, description: Expiration in seconds }

    EnrollmentVerifyInput:
      type: object
      required: [challengeId, credential]
      properties:
        challengeId: { type: string }
        credential:
          type: object
          description: WebAuthn attestation response from the client.
          additionalProperties: true

    EnrollmentVerifyResponse:
      type: object
      required: [credentialId, deviceId]
      properties:
        credentialId: { type: string }
        deviceId: { type: string }

    CreateUserInput:
      type: object
      required: [email]
      properties:
        email: { type: string, format: email }

    EnvelopeUser:
      type: object
      required: [data]
      properties:
        data: { $ref: '#/components/schemas/User' }
        meta: { $ref: '#/components/schemas/Meta' }

    EnvelopeUsers:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/User' }
        meta: { $ref: '#/components/schemas/Meta' }

    EnvelopeDevices:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/Device' }
        meta: { $ref: '#/components/schemas/Meta' }

    EnvelopeChallengeResponse:
      type: object
      required: [data]
      properties:
        data: { $ref: '#/components/schemas/ChallengeResponse' }

    EnvelopeAuthVerifyResponse:
      type: object
      required: [data]
      properties:
        data: { $ref: '#/components/schemas/AuthVerifyResponse' }

    EnvelopeEnrollmentVerifyResponse:
      type: object
      required: [data]
      properties:
        data: { $ref: '#/components/schemas/EnrollmentVerifyResponse' }

paths:
  /health:
    get:
      tags: [Health]
      summary: Liveness check
      operationId: getHealth
      parameters:
        - $ref: '#/components/parameters/XRequestId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
        default:
          $ref: '#/components/responses/Problem'

  /v1/auth/challenge:
    post:
      tags: [Auth]
      summary: Create authentication challenge (WebAuthn assertion)
      operationId: authCreateChallenge
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthChallengeInput' }
      responses:
        '200':
          description: Challenge issued
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeChallengeResponse' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
            Idempotency-Replayed:
              $ref: '#/components/headers/IdempotencyReplayed'
        default:
          $ref: '#/components/responses/Problem'

  /v1/auth/verify:
    post:
      tags: [Auth]
      summary: Verify authentication assertion and issue tokens
      operationId: authVerify
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthVerifyInput' }
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeAuthVerifyResponse' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
            Idempotency-Replayed:
              $ref: '#/components/headers/IdempotencyReplayed'
        default:
          $ref: '#/components/responses/Problem'

  /v1/enroll/challenge:
    post:
      tags: [Enrollment]
      summary: Create enrollment challenge (WebAuthn attestation)
      operationId: enrollCreateChallenge
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EnrollmentChallengeInput' }
      responses:
        '200':
          description: Challenge issued
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeChallengeResponse' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
            Idempotency-Replayed:
              $ref: '#/components/headers/IdempotencyReplayed'
        default:
          $ref: '#/components/responses/Problem'

  /v1/enroll/verify:
    post:
      tags: [Enrollment]
      summary: Verify enrollment attestation and store credential
      operationId: enrollVerify
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EnrollmentVerifyInput' }
      responses:
        '200':
          description: Device enrolled
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeEnrollmentVerifyResponse' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
            Idempotency-Replayed:
              $ref: '#/components/headers/IdempotencyReplayed'
        default:
          $ref: '#/components/responses/Problem'

  /v1/users:
    post:
      tags: [Users]
      summary: Create a user
      operationId: createUser
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateUserInput' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeUser' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
            Location:
              $ref: '#/components/headers/Location'
        '409':
          description: Conflict (e.g., email already exists)
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/ProblemDetails' }
        default:
          $ref: '#/components/responses/Problem'
      security:
        - bearerAuth: []

    get:
      tags: [Users]
      summary: List users (cursor pagination)
      operationId: listUsers
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeUsers' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
        default:
          $ref: '#/components/responses/Problem'
      security:
        - bearerAuth: []

  /v1/users/{id}:
    get:
      tags: [Users]
      summary: Get a user by id
      operationId: getUser
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeUser' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/ProblemDetails' }
        default:
          $ref: '#/components/responses/Problem'
      security:
        - bearerAuth: []

  /v1/devices:
    get:
      tags: [Devices]
      summary: List devices for current user/tenant
      operationId: listDevices
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeDevices' }
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
        default:
          $ref: '#/components/responses/Problem'
      security:
        - bearerAuth: []

  /v1/devices/{id}:
    delete:
      tags: [Devices]
      summary: Revoke a device by id
      operationId: revokeDevice
      parameters:
        - $ref: '#/components/parameters/XRequestId'
        - $ref: '#/components/parameters/IdempotencyKey'
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '204':
          description: Deleted
          headers:
            X-Request-Id:
              $ref: '#/components/headers/XRequestId'
        '404':
          description: Not found
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/ProblemDetails' }
        default:
          $ref: '#/components/responses/Problem'
      security:
        - bearerAuth: []
  /v1/auth/password/register:
    post:
      tags: [Auth]
      summary: Register with email/password
      operationId: passwordRegister
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, firstName, lastName]
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
                firstName: { type: string }
                lastName: { type: string }
      responses:
        '201':
          description: Registered
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeAuthTokens' }
        default:
          $ref: '#/components/responses/Problem'
  /v1/auth/password/login:
    post:
      tags: [Auth]
      summary: Login with email/password
      operationId: passwordLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string }
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeAuthTokens' }
        default:
          $ref: '#/components/responses/Problem'
  /v1/auth/password/refresh:
    post:
      tags: [Auth]
      summary: Rotate refresh token
      operationId: passwordRefresh
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        '200':
          description: New tokens
          content:
            application/json:
              schema: { $ref: '#/components/schemas/EnvelopeAuthTokens' }
        default:
          $ref: '#/components/responses/Problem'
  /v1/auth/password/logout:
    post:
      tags: [Auth]
      summary: Logout/revoke refresh token
      operationId: passwordLogout
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        '200': { description: OK }
        default:
          $ref: '#/components/responses/Problem'
